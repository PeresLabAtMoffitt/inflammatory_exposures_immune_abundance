---
title: "Investigate data"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cerulean #darkly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   margin-bottom: 25;
}

table {
    margin-top: 25px;
    margin-bottom: 10px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Association between pre-diagnostic inflammatory-related exposures and immune cell abundance</span>

</div>
<br>

```{r library, include=FALSE}
# library(drake)
library(tidyverse)
library(data.table)
library(nnet)
library(gtsummary)
library(survival)
library(survminer)
library(mclust)
library(gplots)
```

```{r load}
ROI_global <- readRDS(paste0(here::here(), "/ROI_global.rds"))
clinical_data <- readRDS(paste0(here::here(), "/clinical_data.rds"))
# Rewove patients not matched or lost match
ROI_global <- left_join(ROI_global, clinical_data, by="suid") %>%
  filter(!image_tag %in% c("Peres_P1_150163  3D_[44113,18531].tif", 
                           "Peres_P1_43004 A2_[45654,5840].tif",
                           "Peres_P1_43773 D2_[60849,15244].tif", 
                         "Peres_P1_AACES 130033_[37754,17929].tif",
                         "Peres_P1_AACES 130033_[38351,13944].tif"
                           )) %>% 
  select(suid, pair_id, everything()) %>% 
  drop_na(pair_id) %>% 
  group_by(pair_id) %>% 
  mutate(have_a_match = dense_rank(interaction(suid, pair_id))) %>% 
  group_by(pair_id) %>% 
  mutate(is_paired = max(have_a_match)) %>% 
  filter(is_paired == 2) %>% 
  select(pair_id, everything(), -c(is_paired, have_a_match)) %>% 
  ungroup() %>% 
  mutate(strenpa = factor(strenpa))
# markers_match <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_match.rds")
path <- fs::path("","Volumes","Peres_Research","Christelle Colin-Leitzinger")
```
<br>
<br>

***

```{r summarize mean}
markers_ROIi <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  group_by(suid) %>% 
  summarize(
    mean_tumor = mean(percent_tumor),
    mean_stroma = mean(percent_stroma),
    mean_total = mean(percent_total),
    # variance_tumor = var(percent_tumor),
    # variance_stroma = var(percent_stroma),
    percent_CD3_tumor = mean(tumor_percent_cd3_opal_650_positive_cells),
    percent_CD8_tumor = mean(tumor_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_tumor = mean(tumor_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_tumor = mean(tumor_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_tumor = mean(tumor_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_tumor = mean(tumor_percent_cd11b_opal_620_positive_cells),
    percent_CD15_tumor = mean(tumor_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_tumor = mean(tumor_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_stroma = mean(stroma_percent_cd3_opal_650_positive_cells),
    percent_CD8_stroma = mean(stroma_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_stroma = mean(stroma_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_stroma = mean(stroma_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_stroma = mean(stroma_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_stroma = mean(stroma_percent_cd11b_opal_620_positive_cells),
    percent_CD15_stroma = mean(stroma_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_stroma = mean(stroma_percent_cd11bplus_cd15plus_positive_cells),
    
    percent_CD3_total = mean(percent_cd3_opal_650_positive_cells),
    percent_CD8_total = mean(percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_total = mean(percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_total = mean(percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_total = mean(percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_total = mean(percent_cd11b_opal_620_positive_cells),
    percent_CD15_total = mean(percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_total = mean(percent_cd11bplus_cd15plus_positive_cells)
  )
#
markers_ROIp <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  group_by(suid) %>% 
  summarize(
    mean_tumor = mean(percent_tumor),
    mean_stroma = mean(percent_stroma),
    mean_total = mean(percent_total),
    # variance_tumor = var(percent_tumor),
    # variance_stroma = var(percent_stroma),
    percent_CD3_tumor = mean(tumor_percent_cd3_opal_650_positive_cells),
    percent_CD8_tumor = mean(tumor_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_tumor = mean(tumor_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_tumor = mean(tumor_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_tumor = mean(tumor_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_tumor = mean(tumor_percent_cd11b_opal_620_positive_cells),
    percent_CD15_tumor = mean(tumor_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_tumor = mean(tumor_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_stroma = mean(stroma_percent_cd3_opal_650_positive_cells),
    percent_CD8_stroma = mean(stroma_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_stroma = mean(stroma_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_stroma = mean(stroma_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_stroma = mean(stroma_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_stroma = mean(stroma_percent_cd11b_opal_620_positive_cells),
    percent_CD15_stroma = mean(stroma_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_stroma = mean(stroma_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_total = mean(percent_cd3_opal_650_positive_cells),
    percent_CD8_total = mean(percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_total = mean(percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_total = mean(percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_total = mean(percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_total = mean(percent_cd11b_opal_620_positive_cells),
    percent_CD15_total = mean(percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_total = mean(percent_cd11bplus_cd15plus_positive_cells)
  )
# Join Intratumoral and Peropheral ROI
markers_ROI <- full_join(markers_ROIi, markers_ROIp,
                         by= "suid", suffix= c(".i", ".p"))
markers_ROI <- left_join(markers_ROI, clinical_data, by="suid")
```

```{r cat low and high with absent}
markers_ROI <- markers_ROI %>% 
  
  mutate(CD3_tumor.i = case_when(
    percent_CD3_tumor.i <= 1      ~ "low",
    percent_CD3_tumor.i > 1       ~ "high"
  ), CD3_tumor.i = factor(CD3_tumor.i, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_tumor.i = case_when(
    percent_CD3_CD8_tumor.i <= 1      ~ "low",
    percent_CD3_CD8_tumor.i > 1       ~ "high"
  ), CD3_CD8_tumor.i = factor(CD3_CD8_tumor.i, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_tumor.i = case_when(
    percent_CD3_FoxP3_tumor.i <= 1      ~ "low",
    percent_CD3_FoxP3_tumor.i > 1       ~ "high"
  ), CD3_FoxP3_tumor.i = factor(CD3_FoxP3_tumor.i, levels = c("low","high"))) %>% 
  mutate(CD11b_tumor.i = case_when(
    percent_CD11b_tumor.i == 0      ~ "Absence",
    percent_CD11b_tumor.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor.i = case_when(
    percent_CD11b_CD15_tumor.i == 0      ~ "Absence",
    percent_CD11b_CD15_tumor.i > 0       ~ "Presence"
  )) %>% 
  
  mutate(CD3_stroma.i = case_when(
    percent_CD3_stroma.i <= 1      ~ "low",
    percent_CD3_stroma.i > 1       ~ "high"
  ), CD3_stroma.i = factor(CD3_stroma.i, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_stroma.i = case_when(
    percent_CD3_CD8_stroma.i <= 1      ~ "low",
    percent_CD3_CD8_stroma.i > 1       ~ "high"
  ), CD3_CD8_stroma.i = factor(CD3_CD8_stroma.i, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_stroma.i = case_when(
    percent_CD3_FoxP3_stroma.i <= 1      ~ "low",
    percent_CD3_FoxP3_stroma.i > 1       ~ "high"
  ), CD3_FoxP3_stroma.i = factor(CD3_FoxP3_stroma.i, levels = c("low","high"))) %>% 
  mutate(CD11b_stroma.i = case_when(
    percent_CD11b_stroma.i == 0      ~ "Absence",
    percent_CD11b_stroma.i > 0       ~ "Presence"
  )) %>%
  mutate(CD11b_CD15_stroma.i = case_when(
    percent_CD11b_CD15_stroma.i == 0      ~ "Absence",
    percent_CD11b_CD15_stroma.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_stroma.i3 = case_when(
    percent_CD11b_stroma.i <= 1      ~ "low",
    percent_CD11b_stroma.i > 1       ~ "high"
  ), CD11b_stroma.i3 = factor(CD11b_stroma.i3, levels = c("low","high"))) %>%
  mutate(CD11b_CD15_stroma.i3 = case_when(
    percent_CD11b_CD15_stroma.i <= 1      ~ "low",
    percent_CD11b_CD15_stroma.i > 1       ~ "high"
  ), CD11b_CD15_stroma.i3 = factor(CD11b_CD15_stroma.i3, levels = c("low","high"))) %>% 
  mutate(CD3_total.i = case_when(
    percent_CD3_total.i <= 1      ~ "low",
    percent_CD3_total.i > 1       ~ "high"
  ), CD3_total.i = factor(CD3_total.i, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_total.i = case_when(
    percent_CD3_CD8_total.i <= 1      ~ "low",
    percent_CD3_CD8_total.i > 1       ~ "high"
  ), CD3_CD8_total.i = factor(CD3_CD8_total.i, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_total.i = case_when(
    percent_CD3_FoxP3_total.i <= 1      ~ "low",
    percent_CD3_FoxP3_total.i > 1       ~ "high"
  ), CD3_FoxP3_total.i = factor(CD3_FoxP3_total.i, levels = c("low","high"))) %>% 
  mutate(CD11b_total.i = case_when(
    percent_CD11b_total.i == 0      ~ "Absence",
    percent_CD11b_total.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total.i = case_when(
    percent_CD11b_CD15_total.i == 0      ~ "Absence",
    percent_CD11b_CD15_total.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_total.i3 = case_when(
    percent_CD11b_total.i <= 1      ~ "low",
    percent_CD11b_total.i > 1       ~ "high"
  ), CD11b_total.i3 = factor(CD11b_total.i3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_total.i3 = case_when(
    percent_CD11b_CD15_total.i <= 1      ~ "low",
    percent_CD11b_CD15_total.i > 1       ~ "high"
  ), CD11b_CD15_total.i3 = factor(CD11b_CD15_total.i3, levels = c("low","high"))) %>% 
  
  
  mutate(CD3_tumor.p = case_when(
    percent_CD3_tumor.p <= 1      ~ "low",
    percent_CD3_tumor.p > 1       ~ "high"
  ), CD3_tumor.p = factor(CD3_tumor.p, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_tumor.p = case_when(
    percent_CD3_CD8_tumor.p <= 1      ~ "low",
    percent_CD3_CD8_tumor.p > 1       ~ "high"
  ), CD3_CD8_tumor.p = factor(CD3_CD8_tumor.p, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_tumor.p = case_when(
    percent_CD3_FoxP3_tumor.p <= 1      ~ "low",
    percent_CD3_FoxP3_tumor.p > 1       ~ "high"
  ), CD3_FoxP3_tumor.p = factor(CD3_FoxP3_tumor.p, levels = c("low","high"))) %>% 
  mutate(CD11b_tumor.p = case_when(
    percent_CD11b_tumor.p == 0      ~ "Absence",
    percent_CD11b_tumor.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor.p = case_when(
    percent_CD11b_CD15_tumor.p == 0      ~ "Absence",
    percent_CD11b_CD15_tumor.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_tumor.p3 = case_when(
    percent_CD11b_tumor.p <= 1      ~ "low",
    percent_CD11b_tumor.p > 1         ~ "high"
  ), CD11b_tumor.p3 = factor(CD11b_tumor.p3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_tumor.p3 = case_when(
    percent_CD11b_CD15_tumor.p <= 1      ~ "low",
    percent_CD11b_CD15_tumor.p > 1       ~ "high"
  ), CD11b_CD15_tumor.p3 = factor(CD11b_CD15_tumor.p3, levels = c("low","high"))) %>% 
  mutate(CD3_stroma.p = case_when(
    percent_CD3_stroma.p <= 1      ~ "low",
    percent_CD3_stroma.p > 1       ~ "high"
  ), CD3_stroma.p = factor(CD3_stroma.p, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_stroma.p = case_when(
    percent_CD3_CD8_stroma.p <= 1      ~ "low",
    percent_CD3_CD8_stroma.p > 1       ~ "high"
  ), CD3_CD8_stroma.p = factor(CD3_CD8_stroma.p, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_stroma.p = case_when(
    percent_CD3_FoxP3_stroma.p <= 1      ~ "low",
    percent_CD3_FoxP3_stroma.p > 1       ~ "high"
  ), CD3_FoxP3_stroma.p = factor(CD3_FoxP3_stroma.p, levels = c("low","high"))) %>% 
  mutate(CD11b_stroma.p = case_when(
    percent_CD11b_stroma.p == 0      ~ "Absence",
    percent_CD11b_stroma.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_stroma.p = case_when(
    percent_CD11b_CD15_stroma.p == 0      ~ "Absence",
    percent_CD11b_CD15_stroma.p > 0       ~ "Presence"
  )) %>% 
    mutate(CD11b_stroma.p3 = case_when(
    percent_CD11b_stroma.p <= 1      ~ "low",
    percent_CD11b_stroma.p > 1       ~ "high"
  ), CD11b_stroma.p3 = factor(CD11b_stroma.p3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_stroma.p3 = case_when(
    percent_CD11b_CD15_stroma.p <= 1      ~ "low",
    percent_CD11b_CD15_stroma.p > 1       ~ "high"
  ), CD11b_CD15_stroma.p3 = factor(CD11b_CD15_stroma.p3, levels = c("low","high"))) %>% 
  mutate(CD3_total.p = case_when(
    percent_CD3_total.p <= 1      ~ "low",
    percent_CD3_total.p > 1       ~ "high"
  ), CD3_total.p = factor(CD3_total.p, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_total.p = case_when(
    percent_CD3_CD8_total.p <= 1      ~ "low",
    percent_CD3_CD8_total.p > 1       ~ "high"
  ), CD3_CD8_total.p = factor(CD3_CD8_total.p, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_total.p = case_when(
    percent_CD3_FoxP3_total.p <= 1      ~ "low",
    percent_CD3_FoxP3_total.p > 1       ~ "high"
  ), CD3_FoxP3_total.p = factor(CD3_FoxP3_total.p, levels = c("low","high"))) %>% 
  mutate(CD11b_total.p = case_when(
    percent_CD11b_total.p == 0      ~ "Absence",
    percent_CD11b_total.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total.p = case_when(
    percent_CD11b_CD15_total.p == 0      ~ "Absence",
    percent_CD11b_CD15_total.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_total.p3 = case_when(
    percent_CD11b_total.p <= 1      ~ "low",
    percent_CD11b_total.p > 1       ~ "high"
  ), CD11b_total.p3 = factor(CD11b_total.p3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_total.p3 = case_when(
    percent_CD11b_CD15_total.p <= 1      ~ "low",
    percent_CD11b_CD15_total.p > 1       ~ "high"
  ), CD11b_CD15_total.p3 = factor(CD11b_CD15_total.p3, levels = c("low","high"))) %>% 
  mutate(across(where(is.character), ~ as.factor(.))) %>% 
  mutate(BMI_recent_5 = BMI_recent / 5) %>% 
  mutate(BMI_YA_5 = BMI_YA / 5)
```

```{r immunoscore per patients mean}
markers_ROI <- markers_ROI %>% 
  mutate(percentile_score_CD3_i = ntile(percent_CD3_total.i, 100) ) %>% 
  mutate(percentile_score_CD3_p = ntile(percent_CD3_total.p, 100) ) %>% 
  mutate(percentile_score_CD8_i = ntile(percent_CD8_total.i, 100) ) %>% 
  mutate(percentile_score_CD8_p = ntile(percent_CD8_total.p, 100) ) 
markers_ROI <- markers_ROI %>%
  mutate(percentile_score_mean = rowMeans( markers_ROI[c("percentile_score_CD3_i", "percentile_score_CD3_p", 
                                                    "percentile_score_CD8_i", "percentile_score_CD8_p")] ))
markers_ROI <- markers_ROI %>%
  mutate(immunoscore_patients = case_when(
    percentile_score_mean <= 10        ~ 0,
    percentile_score_mean <= 25        ~ 1,
    percentile_score_mean <= 70        ~ 2,
    percentile_score_mean <= 95        ~ 3,
    percentile_score_mean > 95         ~ 4 
  )) %>% 
  mutate(immunoscore_patients = factor(immunoscore_patients)) %>% 
  mutate(immunoscore_2018lancet_patients = case_when(
    percentile_score_mean <= 25        ~ "Low",
    percentile_score_mean <= 70        ~ "Intermediate",
    percentile_score_mean > 70         ~ "High"
    )) %>% 
  mutate(immunoscore_2018lancet_patients = factor(immunoscore_2018lancet_patients, levels = c("Low", "Intermediate", "High"))) 
```

```{r clustering}
# set.seed(1234)
# ### Cluster for stroma/tumor in the intratumoral/peritumoral ROIs
# clust_markers <- markers_ROI %>%
#   filter(!is.na(markers_ROI$percent_CD3_CD8_tumor.i) & !is.na(markers_ROI$percent_CD3_CD8_tumor.p)) %>%
#   select(suid, c("percent_CD3_tumor.i", "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", "percent_CD11b_tumor.i", "percent_CD11b_CD15_tumor.i",
#                  "percent_CD3_stroma.i", "percent_CD3_CD8_stroma.i", "percent_CD3_FoxP3_stroma.i", "percent_CD11b_stroma.i", "percent_CD11b_CD15_stroma.i",
#                  "percent_CD3_tumor.p", "percent_CD3_CD8_tumor.p", "percent_CD3_FoxP3_tumor.p", "percent_CD11b_tumor.p", "percent_CD11b_CD15_tumor.p",
#                  "percent_CD3_stroma.p", "percent_CD3_CD8_stroma.p", "percent_CD3_FoxP3_stroma.p", "percent_CD11b_stroma.p", "percent_CD11b_CD15_stroma.p"
#                  ))
# clust <- Mclust(scale(clust_markers[,c(2:ncol(clust_markers))]))
# # summary(clust)
# clust_markers$clusters_all_IandP <- clust$classification
# clust_markers$clusters_all_IandP <- factor(clust_markers$clusters_all_IandP,
#                                            levels = c(1, 2, 3, 4, 5),
#                                            labels = c("mid", "high", "mid-high", "mid-low", "low"))
# clust_markers <- clust_markers %>%
#   mutate(clusters_all_IandP = factor(clusters_all_IandP,
#                                      levels = c("low", "mid-low", "mid", "mid-high", "high")))
# # clust_markers %>%
# # tidyr::gather(key = "markers_cat", value = "value",
# #               c("percent_CD3_tumor.i":"percent_CD11b_CD15_stroma.i")) %>%
# #   select(suid, clusters_all_IandP, markers_cat, value) %>%
# #   ggplot(aes(x=suid, y=value, group=markers_cat,  color=markers_cat))+
# #   geom_boxplot()+
# #   facet_grid(.~ clusters_all_IandP)
# # clust_markers %>%
# # tidyr::gather(key = "markers_cat", value = "value",
# #               c("percent_CD3_tumor.p":"percent_CD11b_CD15_stroma.p")) %>%
# #   select(suid, clusters_all_IandP, markers_cat, value) %>%
# #   ggplot(aes(x=suid, y=value, group=markers_cat,  color=markers_cat))+
# #   geom_boxplot()+
# #   facet_grid(.~ clusters_all_IandP)
# markers_ROI <- full_join(markers_ROI, clust_markers %>% select(suid, clusters_all_IandP), by = "suid")
```


# I. Data exploration
## 1. Patient characteristics
```{r patient table}
markers_ROI %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  select(refage, refage_cat, stage, BMI_recent, BMI_recent_grp,
        smoker, diab, histology,
         dblkstat_CA125, adj,
        eur_prop, afr_prop, asian_prop,
        eurpc1, eurpc2, pc1, pc2,
         race) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(refage ~ "Age at diagnosis", refage_cat ~ "Age at diagnosis category",
                           dblkstat_CA125 ~ "Debulking Status", adj ~ "Adjuvant chemotherapy",
                           smoker ~ "Smoking status"),
              type = list(diab ~ "categorical"),
              digits = list(all_continuous() ~ 1)) %>%
      modify_header(list(label ~ "**Patient characteristics**", all_stat_cols() ~ "**{level}**, N = {n}")) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
```

# 2. Distribution of the potential inflammatory-related pre-diagnostic exposures in the overall study population, by race, and by immune abundance (only use overall intratumoral and overall peritumoral), immune signatures, and immunoscore

## Summary table
```{r exposures table}
exposure_var <- c("BMI_recent_grp", "BMI_YA_grp", "smokever", "smokcurrent",
                  "packyrs", "talcever", "talcgen", "talcnongen",
                  "aspirin", "NSAID", "aceta", "hyster1yr",
                  "hyster2yr", "hystertype",
                  "tubelig", "tubelig1yr", "endomet", "fibroids",
                  "pid", "education",
                  "married", "anyfhdur") 
marker_var <- c("percent_CD3_total.i", "percent_CD3_CD8_total.i", 
                "percent_CD3_FoxP3_total.i", "percent_CD11b_total.i", 
                "percent_CD11b_CD15_total.i",
                 "percent_CD3_total.p", "percent_CD3_CD8_total.p", 
                "percent_CD3_FoxP3_total.p", "percent_CD11b_total.p", 
                "percent_CD11b_CD15_total.p")

markers_ROI %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  select(BMI_recent_grp, BMI_YA_grp, smokever, smokcurrent,
         packyrs, talcever, talcgen, talcnongen,
         aspirin, NSAID,aceta, hyster, hyster1yr,
         hyster2yr, hystertype,
         tubelig, tubelig1yr, endomet, fibroids,
         pid, education,
         married, anyfhdur,
         race) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              # label = list(refage ~ "Age at diagnosis", refage_cat ~ "Age at diagnosis category",
              #              dblkstat_CA125 ~ "Debulking Status", adj ~ "Adjuvant chemotherapy",
              #              smoker ~ "Smoking status"),
              type = list(c(talcever, talcgen, talcnongen,
                            aspirin, NSAID,aceta, hyster1yr,
                            hyster2yr, hystertype,
                            tubelig, tubelig1yr, endomet, fibroids,
                            pid, education,
                            married) ~ "categorical"),
              digits = list(all_continuous() ~ 1)
  ) %>%
  modify_header(list(label ~ "**Patient Exposure characteristics**", all_stat_cols() ~ "**{level}**, N = {n}")) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
```

## Violin plots
```{r violin}
# for (j in marker_var){
#
#   for (i in exposure_var){
#     p1 <- markers_ROI %>%
#       ggplot()+
#       geom_violin(aes(x=i, y=percent_CD3_total.i), scale = "count")+
#       geom_boxplot(aes(x=i, y=percent_CD3_total.i), width=.1) +
#       theme_classic2()+
#       labs(x=NULL, y=NULL, title="Intratumoral \nROIs")
#     p2 <- markers_ROI %>%
#       ggplot()+
#       geom_violin(aes(x=i, y=j), scale = "count")+
#       geom_boxplot(aes(x=i, y=j), width=.1) +
#       theme_classic2()+
#       labs(x=NULL, y=NULL, title="Peripheral \nROIs")
#
#     gridExtra::grid.arrange(p1, p2, ncol = 2,
#                             top = "% of Cells Present in", left =  paste("Overall", markers_ROI[[i]], "immune cells (%) per patients"),
#                             bottom = "Data on Race-Matched Patients")
#   }
# }

violin_plot <- function(data, type){

  for (i in exposure_var){

    if(class(markers_ROI[[i]]) == "factor" | class(markers_ROI[[i]]) == "character") {

      p1 <- markers_ROI %>%
        ggplot()+
        geom_violin(aes(x=.data[[i]], y= .data[[paste0(type, ".i")]]), scale = "count")+
        geom_boxplot(aes(x=.data[[i]], y= .data[[paste0(type, ".i")]]), width=.1) +
        theme_classic2()+
        labs(x=NULL, y=NULL, title="Intratumoral \nROIs")
      p2 <- markers_ROI %>%
        ggplot()+
        geom_violin(aes(x=.data[[i]], y= .data[[paste0(type, ".p")]]), scale = "count")+
        geom_boxplot(aes(x=.data[[i]], y= .data[[paste0(type, ".p")]]), width=.1) +
        theme_classic2()+
        labs(x=NULL, y=NULL, title="Peripheral \nROIs")

      main <- str_match(type, "percent_(.*)_total")[,2]
      gridExtra::grid.arrange(p1, p2, ncol = 2,
                              top = "% of Cells Present in",
                              left =  paste("Overall", main, "immune cells (%) per patients"),
                              bottom = "Data on Race-Matched Patients")
    }
  }
}

violin_plot(data = markers_ROI, type = "percent_CD3_total")
violin_plot(data = markers_ROI, type = "percent_CD3_CD8_total")
violin_plot(data = markers_ROI, type = "percent_CD3_FoxP3_total")
violin_plot(data = markers_ROI, type = "percent_CD11b_total")
violin_plot(data = markers_ROI, type = "percent_CD11b_CD15_total")
```

## Scatter plots
```{r point}
# markers_ROI %>%
#         ggplot(aes(x=.data[[i]], y= .data[[paste0("percent_CD3_total", ".i")]]))+
#   geom_point()+
#   geom_smooth(method = "lm", se = FALSE) +
# stat_regline_equation(label.y.npc = 1)+
#         # geom_violin(aes(x=.data[[i]], y= .data[[paste0("percent_CD3_total", ".i")]]), scale = "count")+
#         # geom_boxplot(aes(x=.data[[i]], y= .data[[paste0("percent_CD3_total", ".i")]]), width=.1) +
#         theme_classic2()+
#         labs(x=NULL, y=NULL, title="Intratumoral \nROIs")


point_plot <- function(data, type){

  for (i in exposure_var){

    if(class(markers_ROI[[i]]) == "numeric" | class(markers_ROI[[i]]) == "integer") {

      p1 <- markers_ROI %>%
        ggplot(aes(x=.data[[i]], y= .data[[paste0(type, ".i")]]))+
        geom_point()+
        geom_smooth(method = "lm", se = FALSE)+
        stat_regline_equation(label.y.npc = 1)+
        theme_classic2()+
        labs(y=NULL, title="Intratumoral \nROIs")
      p2 <- markers_ROI %>%
        ggplot(aes(x=.data[[i]], y= .data[[paste0(type, ".p")]]))+
        geom_point()+
        geom_smooth(method = "lm", se = FALSE)+
        stat_regline_equation(label.y.npc = 1)+
        theme_classic2()+
        labs(y=NULL, title="Peripheral \nROIs")

      main <- str_match(type, "percent_(.*)_total")[,2] %>%
        str_remove(., "_")
      gridExtra::grid.arrange(p1, p2, ncol = 2,
                              top = "% of Cells Present in",
                              left =  paste("Overall", main, "immune cells (%) per patients"),
                              bottom = "Data on Race-Matched Patients")
    }
  }
}
point_plot(data = markers_ROI, type = "percent_CD3_total")
point_plot(data = markers_ROI, type = "percent_CD3_CD8_total")
point_plot(data = markers_ROI, type = "percent_CD3_FoxP3_total")
point_plot(data = markers_ROI, type = "percent_CD11b_total")
point_plot(data = markers_ROI, type = "percent_CD11b_CD15_total")
```
<br>
<br>

***
***

<br>

# Logistic regression adjusted by age + stage + race

```{r log reg function}
exp_var <- c("BMI_recent_grp", "BMI_recent_5", "BMI_YA_grp", "smokever", "smokcurrent",
                  "packyrs", "talcever", "talcgen", "talcnongen",
                  "aspirin", "NSAID", "aceta", "hyster1yr",
                  "hyster2yr", "hystertype",
                  "tubelig", "endomet", "fibroids",
                  "pid", "education",
                  "married", "anyfhdur") 

loreg_table_int <- function(data, type){
  
  for (i in exp_var){
    
    main <- str_match(type, "(.*)_total")[,2] %>% 
      str_remove(., "_")
    
    tbl1 <- glm(data[[paste0(type, ".i")]] ~ data[[i]] + refage + stage + race, 
                data = data, family = "binomial") %>%
            tbl_regression(exponentiate = TRUE, 
                           label = list(`data[[i]]` ~ i)) %>% 
            modify_spanning_header(everything() ~ paste("Association with Overall", main, "Intratumoral"))
    print(tbl1)
    
  }
}

loreg_table_per <- function(data, type){

  for (i in exp_var){

    main <- str_match(type, "(.*)_total")[,2] %>%
      str_remove(., "_")

    tbl2 <- glm(data[[paste0(type, ".p")]] ~ data[[i]] + refage + stage + race, 
                data = data, family = "binomial") %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
            modify_spanning_header(everything() ~ paste("Association with Overall", main, "Peripheral"))
    print(tbl2)

  }
}
```

## Overall

### CD3_total

<div class = "row">
<div class = "col-md-6">
```{r log reg intra, results = 'asis'}
loreg_table_int(data = markers_ROI, type = "CD3_total")
```
</div>

<div class = "col-md-6">
```{r log reg periph, results = 'asis'}
# loreg_table_per(data = markers_ROI, type = "CD3_total")
```
</div>
</div>

***

### CD3_CD8_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI, type = "CD3_CD8_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI, type = "CD3_CD8_total")
```
</div>
</div>

***

### CD3_FoxP3_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI, type = "CD3_FoxP3_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI, type = "CD3_FoxP3_total")
```
</div>
</div>

***

### CD11b_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI, type = "CD11b_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI, type = "CD11b_total")
```
</div>
</div>

***

### CD11b_CD15_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI, type = "CD11b_CD15_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI, type = "CD11b_CD15_total")
```
</div>
</div>

<br>

***

## White

```{r}
markers_ROI_white <- markers_ROI %>% 
  filter(race == "White")
```

```{r}
loreg_table_int <- function(data, type){
  
  for (i in exp_var){
    
    main <- str_match(type, "(.*)_total")[,2] %>% 
      str_remove(., "_")
    
    tbl1 <- glm(data[[paste0(type, ".i")]] ~ data[[i]] + refage + stage, 
                data = data, family = "binomial") %>%
            tbl_regression(exponentiate = TRUE, 
                           label = list(`data[[i]]` ~ i)) %>% 
            modify_spanning_header(everything() ~ paste("Association with Overall", main, "Intratumoral"))
    print(tbl1)
    
  }
}

loreg_table_per <- function(data, type){

  for (i in exp_var){

    main <- str_match(type, "(.*)_total")[,2] %>%
      str_remove(., "_")

    tbl2 <- glm(data[[paste0(type, ".p")]] ~ data[[i]] + refage + stage, 
                data = data, family = "binomial") %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
            modify_spanning_header(everything() ~ paste("Association with Overall", main, "Peripheral"))
    print(tbl2)

  }
}
```

### CD3_total

<div class = "row">
<div class = "col-md-6">
```{r log reg intra white, results = 'asis'}
loreg_table_int(data = markers_ROI_white, type = "CD3_total")
```
</div>

<div class = "col-md-6">
```{r log reg periph white, results = 'asis'}
# loreg_table_per(data = markers_ROI_white, type = "CD3_total")
```
</div>
</div>

***

### CD3_CD8_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_white, type = "CD3_CD8_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_white, type = "CD3_CD8_total")
```
</div>
</div>

***

### CD3_FoxP3_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_white, type = "CD3_FoxP3_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_white, type = "CD3_FoxP3_total")
```
</div>
</div>

***

### CD11b_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_white, type = "CD11b_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_white, type = "CD11b_total")
```
</div>
</div>

***

### CD11b_CD15_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_white, type = "CD11b_CD15_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_white, type = "CD11b_CD15_total")
```
</div>
</div>

<br>

***

## Black

### CD3_total

```{r}
markers_ROI_black <- markers_ROI %>%
  filter(race == "Black")
```

<div class = "row">
<div class = "col-md-6">
```{r log reg intra black, results = 'asis'}
loreg_table_int(data = markers_ROI_black, type = "CD3_total")
```
</div>

<div class = "col-md-6">
```{r log reg periph black, results = 'asis'}
# loreg_table_per(data = markers_ROI_black, type = "CD3_total")
```
</div>
</div>

***

### CD3_CD8_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_black, type = "CD3_CD8_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_black, type = "CD3_CD8_total")
```
</div>
</div>

***

### CD3_FoxP3_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_black, type = "CD3_FoxP3_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_black, type = "CD3_FoxP3_total")
```
</div>
</div>

***

### CD11b_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_black, type = "CD11b_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_black, type = "CD11b_total")
```
</div>
</div>

***

### CD11b_CD15_total

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
loreg_table_int(data = markers_ROI_black, type = "CD11b_CD15_total")
```
</div>

<div class = "col-md-6">
```{r, results = 'asis'}
# loreg_table_per(data = markers_ROI_black, type = "CD11b_CD15_total")
```
</div>
</div>

<br>
<br>

***
***

<br>

<!-- ## Immunoscore -->

```{r multi reg function}
multinom_pivot_wider <- function(x) {
  # check inputs match expectatations
  if (!inherits(x, "tbl_regression") || !inherits(x$model_obj, "multinom")) {
    stop("`x=` must be class 'tbl_regression' summary of a `nnet::multinom()` model.")
  }

  # create tibble of results
  df <- tibble::tibble(outcome_level = unique(x$table_body$groupname_col))
  df$tbl <-
    purrr::map(
      df$outcome_level,
      function(lvl) {
        gtsummary::modify_table_body(
          x,
          ~dplyr::filter(.x, .data$groupname_col %in% lvl) %>%
            dplyr::ungroup() %>%
            dplyr::select(-.data$groupname_col)
        )
      }
    )

  tbl_merge(df$tbl, tab_spanner = paste0("**", df$outcome_level, "**"))
}

multireg_table_int <- function(data){

  for (i in exp_var){

    tbl1 <- multinom(immunoscore_patients ~ data[[i]] + refage + stage + race,
                     data = data) %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
  multinom_pivot_wider() #%>%
            # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Intratumoral"))
    print(tbl1)

  }
}

multireg_table_per <- function(data, type){

  for (i in exp_var){

    tbl2 <- multinom(immunoscore_patients ~ data[[i]] + refage + stage + race,
                     data = data) %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
  multinom_pivot_wider()# %>%
            # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Peripheral"))
    print(tbl2)

  }
}
```
<!-- Intratumoral -->

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}

# model <- multinom(immunoscore_patients ~ BMI_recent_grp, data = markers_ROI)
# broom::tidy(model)
# exp(coef(model))
# multinom(immunoscore_patients ~ BMI_recent_grp, data = markers_ROI) %>%
#   tbl_regression(exponentiate = TRUE) %>%
#   multinom_pivot_wider()

# multireg_table_int(data = markers_ROI)
```
</div>

<!-- Peripheral  -->

<div class = "col-md-6">
```{r, results = 'asis'}
# multireg_table_per(data = markers_ROI)
```
</div>
</div>

# Immunoscore 3 cat 2018lancet

What are the weight?
```{r}
multinom(immunoscore_2018lancet_patients ~ immunoscore_patients + refage + stage + race,
                     data = markers_ROI)
```

```{r multi reg}
multireg_table_int <- function(data){

  for (i in exp_var){

    tbl1 <- multinom(immunoscore_2018lancet_patients ~ data[[i]] + refage + stage + race,
                     data = data) %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
  multinom_pivot_wider()# %>%
            # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Intratumoral"))
    print(tbl1)

  }
}

multireg_table_per <- function(data){

  for (i in exp_var){

    tbl2 <- multinom(immunoscore_2018lancet_patients ~ data[[i]] + refage + stage + race,
                     data = data) %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
  multinom_pivot_wider()# %>%
            # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Peripheral"))
    print(tbl2)

  }
}
```

## Overall

### Intratumoral

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
multireg_table_int(data = markers_ROI)
```
</div>

### Peripheral

<div class = "col-md-6">
```{r, results = 'asis'}
multireg_table_per(data = markers_ROI)
```
</div>
</div>

<br>

***

## White

```{r multi reg function race}
multireg_table_int <- function(data){

  for (i in exp_var){

    tbl1 <- multinom(immunoscore_patients ~ data[[i]] + refage + stage,
                     data = data) %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
  multinom_pivot_wider() #%>%
            # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Intratumoral"))
    print(tbl1)

  }
}

multireg_table_per <- function(data, type){

  for (i in exp_var){

    tbl2 <- multinom(immunoscore_patients ~ data[[i]] + refage + stage,
                     data = data) %>%
            tbl_regression(exponentiate = TRUE,
                           label = list(`data[[i]]` ~ i)) %>%
  multinom_pivot_wider()# %>%
            # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Peripheral"))
    print(tbl2)

  }
}
```

### Intratumoral

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
multireg_table_int(data = markers_ROI_white)
```
</div>

### Peripheral

<div class = "col-md-6">
```{r, results = 'asis'}
multireg_table_per(data = markers_ROI_white)
```
</div>
</div>

<br>

***

## Black

### Intratumoral

<div class = "row">
<div class = "col-md-6">
```{r, results = 'asis'}
multireg_table_int(data = markers_ROI_black)
```
</div>

### Peripheral

<div class = "col-md-6">
```{r, results = 'asis'}
multireg_table_per(data = markers_ROI_black)
```
</div>
</div>

<br>

***
***

<br>

<!-- # Cluster -->

<!-- ```{r multi reg cluster} -->
<!-- # multireg_table_int <- function(data){ -->
<!-- #  -->
<!-- #   for (i in exp_var){ -->
<!-- #  -->
<!-- #     tbl1 <- multinom(clusters_all_IandP ~ data[[i]] + refage + stage + race, -->
<!-- #                      data = data) %>% -->
<!-- #             tbl_regression(exponentiate = TRUE, -->
<!-- #                            label = list(`data[[i]]` ~ i)) %>% -->
<!-- #   multinom_pivot_wider() #%>% -->
<!-- #             # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Intratumoral")) -->
<!-- #     print(tbl1) -->
<!-- #  -->
<!-- #   } -->
<!-- # } -->
<!-- #  -->
<!-- # multireg_table_per <- function(data){ -->
<!-- #  -->
<!-- #   for (i in exp_var){ -->
<!-- #  -->
<!-- #     tbl2 <- multinom(clusters_all_IandP ~ data[[i]] + refage + stage + race, -->
<!-- #                      data = data) %>% -->
<!-- #             tbl_regression(exponentiate = TRUE, -->
<!-- #                            label = list(`data[[i]]` ~ i)) %>% -->
<!-- #   multinom_pivot_wider() #%>% -->
<!-- #             # modify_spanning_header(everything() ~ paste("Association with Overall", "immunoscore_patients", "Peripheral")) -->
<!-- #     print(tbl2) -->
<!-- #  -->
<!-- #   } -->
<!-- # } -->
<!-- ``` -->
<!-- <!-- Intratumoral --> -->

<!-- <!-- <div class = "row"> --> -->
<!-- <!-- <div class = "col-md-6"> --> -->
<!-- <!-- ```{r, results = 'asis'} --> -->
<!-- <!-- multireg_table_int(data = markers_ROI) --> -->
<!-- <!-- ``` --> -->
<!-- <!-- </div> --> -->

<!-- <!-- Peripheral  --> -->

<!-- <!-- <div class = "col-md-6"> --> -->
<!-- <!-- ```{r, results = 'asis'} --> -->
<!-- <!-- multireg_table_per(data = markers_ROI) --> -->
<!-- <!-- ``` --> -->
<!-- <!-- </div> --> -->
<!-- <!-- </div> --> -->

<!-- <!-- <br> --> -->


